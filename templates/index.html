{% extends "base.html" %}

{% block content %}
    <h1 class="mb-4">Compartilhagram</h1>
    <div class="row">
        {% for post in posts %}
            <div class="col-md-6 mb-4">
                <div class="card post-card"
                     data-bs-toggle="modal"
                     data-bs-target="#postModal"
                     data-image-src="{{ url_for('static', filename='uploads/' + post.image_file) }}"
                     data-post-caption="{{ post.caption }}"
                     data-post-author="{{ post.author.username }}"
                     data-post-id="{{ post.id }}">
                    <img src="{{ url_for('static', filename='uploads/' + post.image_file) }}" class="card-img-top" alt="Imagem da postagem">
                    <div class="card-body">
                        <p class="card-text"><strong>@{{ post.author.username }}</strong>: {{ post.caption }}</p>

                        <div class="post-actions d-flex align-items-center mb-3">
                            <form action="{{ url_for('like_post', post_id=post.id) }}" method="POST" class="me-2">
                                <button type="submit" class="btn btn-link p-0 like-btn">
                                    {% set liked_by_current_user = false %}
                                    {% for like in post.likes %}
                                        {% if like.user_id == current_user.id %}
                                            {% set liked_by_current_user = true %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if liked_by_current_user %}
                                        <i class="bi bi-heart-fill text-danger"></i>
                                    {% else %}
                                        <i class="bi bi-heart"></i>
                                    {% endif %}
                                </button>
                            </form>
                            <span>{{ post.likes|length }} curtidas</span>
                        </div>

                        <div class="post-comments mb-3">
                            {% for comment in post.comments %}
                                <p class="mb-1"><small><strong>@{{ comment.author.username }}</strong>: {{ comment.text }}</small></p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="modal fade" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="postModalLabel"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body post-modal-body">
                    <img id="modalImage" src="" alt="Imagem completa" class="img-fluid post-modal-image">
                    <p id="modalCaption" class="mt-3"></p>
                    <hr>
                    <div id="modalComments" class="mb-3">
                        </div>
                    {% if current_user.is_authenticated %}
                        <form id="commentForm" method="POST" class="input-group">
                            {{ comment_form.hidden_tag() }}
                            {{ comment_form.text(class="form-control", placeholder="Adicionar um comentário...") }}
                            <button type="submit" class="btn btn-outline-secondary">{{ comment_form.submit.label.text }}</button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const postModal = document.getElementById('postModal');
        if (postModal) {
            postModal.addEventListener('show.bs.modal', event => {
                const button = event.relatedTarget;
                const imageSrc = button.getAttribute('data-image-src');
                const postCaption = button.getAttribute('data-post-caption');
                const postAuthor = button.getAttribute('data-post-author');
                const postId = button.getAttribute('data-post-id');

                const modalImage = postModal.querySelector('#modalImage');
                const modalCaption = postModal.querySelector('#modalCaption');
                const modalTitle = postModal.querySelector('.modal-title');
                const commentForm = postModal.querySelector('#commentForm');

                modalImage.src = imageSrc;
                modalCaption.textContent = `${postAuthor}: ${postCaption}`;
                modalTitle.textContent = `@${postAuthor}`;

                // Define o action do formulário de comentários com o post_id
                if (commentForm) {
                    commentForm.action = `/post/${postId}/comment`;
                }
            });
        }
    </script>
{% endblock %}
